<!DOCTYPE html>
<html>
<head>
  <title>ElixirChat SDK</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=0">
</head>
<style>
  * {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    box-sizing: border-box;
  }
  body {
    padding: 15px 30px 30px 30px;
    font-size: 13px;
  }
  #typing {
    margin: 11px 0;
  }
  #messages {
    padding: 0;
    list-style: none;
    max-height: calc(100vh - 270px);
    overflow-y: auto;
    overflow-x: hidden;
    width: 270px;
  }
  #messages li {
    padding: 3px 55px 8px 8px;
    border: 1px solid #ddd;
    border-radius: 7px;
    width: 250px;
    margin-top: 10px;
    position: relative;
  }
  #messages blockquote {
    color: grey;
    font-style: italic;
    margin: 5px 0;
  }
  #messages div {
    white-space: pre-wrap;
  }
  #messages button {
    position: absolute;
    right: 8px;
    bottom: 8px;
  }
  textarea {
    display: block;
    margin: 14px 0;
    width: 250px;
    font-size: 13px;
    padding: 5px 8px;
  }
  #screenshot-preview {
    width: 50px;
    vertical-align: bottom;
    margin: 0 15px 0 3px;
    box-shadow: 2px 2px 2px rgba(0,0,0,.08);
  }
</style>
<body>
<div>
  <h3>ElixirChat SDK Example</h3>
  <div id="room"></div>
  <div id="client"></div>

  <ul id="messages">
    <a href="#" onclick="loadPreviousMessages(event);">↑ Load previous messages...</a>
    <template id="message-template">
      <li>
        <blockquote></blockquote>
        <b></b>
        <div></div>
        <button>Reply</button>
      </li>
    </template>
  </ul>

  <textarea rows="1" placeholder="Type message and press Enter..." onkeyup="onTextareaKeyup(event)"></textarea>

  <button id="screenshot" onclick="takeScreenshot(event)">Take screenshot</button>
  <img src="" id="screenshot-preview">

  Attach files:
  <input type="file" multiple>
  <div id="typing">Nobody is currently typing</div>
</div>


<script type="text/javascript" src="../sdk.min.js"></script>
<script type="text/javascript">

const elixirChat = new ElixirChat({
  apiUrl: 'https://dev-admin.elixir.chat/api/',
  socketUrl: 'wss://dev-admin.elixir.chat/api/socket',
  companyId: 'd774c50a-42ff-46ba-8ed6-1904d4485ac4',

  /**
   * Remove "room" section if you want a new private room to be created for every unique visitor.
   * @see https://github.com/elixirchat/elixirchat-js-sdk#config-room
   */
  room: {
    id: 'sample-room-id',
    title: 'Sample room title',
    data: {
      custom_sdk_field_1: 'Optional custom SDK field value 1',
      custom_sdk_field_2: 'Optional custom SDK field value 2',
    }
  },

  /**
   * If you remove "client" section, a new random name will be generated for every unique visitor.
   * Client name is generated by https://www.npmjs.com/package/unique-names-generator as [Adjective + Color].
   * Examples:
   *  - Spotty Jade
   *  - Italian Crimson
   *  - Hot Aquamarine, etc
   *
   * @see https://github.com/elixirchat/elixirchat-js-sdk#config-client
   */
  client: {
    id: 'sample-client-id',
    firstName: 'Sample',
    lastName: 'Client'
  },
  debug: true, // Enables verbose console output
});

let messages = [];
let attachments = [];
let screenshot = null;
let replyTo = null;

elixirChat.onConnectSuccess(() => {
  elixirChat.fetchMessageHistory(5).then(history => {
    messages = history;
    renderMessages(messages, true);
  });
  document.getElementById('room').innerHTML = `<b>Room:</b> ${elixirChat.room.title} (ID: ${elixirChat.room.id})`;
  document.getElementById('client').innerHTML = `<b>Client:</b> ${elixirChat.client.firstName} ${elixirChat.client.lastName} (ID: ${elixirChat.client.id})`;
});

elixirChat.onMessage(message => {
  messages.push(message);
  renderMessages(messages, true);
});

elixirChat.onTyping(users => {
  document.getElementById('typing').innerText = users.length ? users.length + ' user(s) typing...' : 'Nobody is currently typing';
});

function takeScreenshot(e){
  elixirChat.takeScreenshot().then(result => {
    screenshot = result.file;
    document.getElementById('screenshot-preview').src = result.dataUrl;
    e.target.disabled = true;
    e.target.innerText = '✔ Screenshot taken';
  }).catch(e => { alert(e.message); });
}

function onTextareaKeyup(e){
  if (e.which === 13 /* "Enter" key */) {
    sendMessage(e.target.value);
    e.target.value = '';
  }
  elixirChat.dispatchTypedText(e.target.value);
}

function sendMessage(text){
  if (text) {
    elixirChat.sendMessage({
      text: text,
      attachments: [screenshot, ...document.querySelector('input[type=file]').files],
      responseToMessageId: replyTo,
    });
    reset();
  }
}

function loadPreviousMessages(e){
  elixirChat.fetchMessageHistory(5, messages[0].cursor).then(history => {
    messages = [...history, ...messages];
    renderMessages(messages);
    if (elixirChat.reachedBeginningOfMessageHistory) {
      e.target.innerText = 'All messages loaded';
      e.target.removeAttribute('href');
    }
  });
  e.preventDefault();
}

function replyToMessage(messageId) {
  replyTo = messageId;
  document.querySelectorAll('#messages li').forEach(li => li.style.border = '');
  if (messageId) {
    document.getElementById(messageId).style.border = '1px solid blue';
    document.getElementsByTagName('textarea')[0].focus();
  }
}

function renderMessages(messages, shouldScrollDown = false){
  const template = document.getElementById('message-template');
  const container = document.getElementById('messages');
  container.querySelectorAll('li').forEach(li => li.remove());
  messages.forEach(message => {
    const clone = document.importNode(template.content, true);
    const responseToMessage = (message.data && message.responseToMessage) || {};
    clone.querySelector('li').id = message.id;
    clone.querySelector('blockquote').textContent = responseToMessage.text ? 'Reply to “' + responseToMessage.text.trim() + '”' : '';
    clone.querySelector('b').textContent = message.sender.firstName + ' ' + message.sender.lastName;
    clone.querySelector('div').textContent = message.text;
    clone.querySelector('button').onclick = () => replyToMessage(message.id);
    container.appendChild(clone);
  });
  if (shouldScrollDown) {
    container.scrollTop = container.scrollHeight;
  }
}

function reset(){
  attachments = [];
  screenshot = null;
  replyToMessage(null);
  document.querySelector('input[type=file]').value = '';
  document.getElementById('screenshot-preview').src = '';
  document.getElementById('screenshot').disabled = false;
  document.getElementById('screenshot').innerText = 'Take screenshot';
}

</script>
</body>
</html>
